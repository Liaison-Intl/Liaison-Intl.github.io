{
  "$schema": "http://json-schema.org/draft-04/hyper-schema",
  "id": "/schemata/pdf_manager_batch",

  "title": "PDF Manager Batch",
  "stability": "prototype",
  "description": "A **PDF Manager batch** represents the asynchronous execution and eventual population of a **PDF Manager template**.",

  "links": [
    {
      "description": "Display existing batch with download URL.",
      "href": "/api/v1/user_identities/:user_identity_id/pdf_manager_batches/:pdf_manager_batch_id",
      "method": "GET",
      "rel": "self",
      "title": "Show",
      "http_header": { "x-api-key": "0123456789abcdef0123456789abcdef" }
    },
    {
      "description": "List existing batches.  Importantly, the download URL is not displayed in this response because these individual expiring URLs can only be generated by calling for the status of an individual batch directly, using the previous call. You can use the results of this call and loop through each one to get download URLs for each batch marked as `\"available\"` or `\"success_with_errors\"`.",
      "href": "/api/v1/user_identities/:user_identity_id/pdf_manager_batches",
      "method": "GET",
      "rel": "instances",
      "title": "List",
      "http_header": { "x-api-key": "0123456789abcdef0123456789abcdef" },
      "targetSchema": {
        "properties": {
          "href": {
            "type": "string",
            "description": "Hypertext reference to this resource.",
            "pattern": "/api/v1/user_identities/\\d+/pdf_manager_batches",
            "example": "/api/v1/user_identities/1/pdf_manager_batches"
          },
          "pdf_manager_batches": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["id", "updated_at", "state", "pdf_manager_template"],
              "properties": {
                "id": {
                  "type": "integer",
                  "example": 2
                },
                "updated_at": {
                  "type": "string",
                  "format": "date-time",
                  "pattern": "\\d\\d\\d\\d-\\d\\d-\\d\\dT\\d\\d:\\d\\d:\\d\\dZ",
                  "example": "2016-01-05T16:51:00Z"
                },
                "state": {
                  "type": "string",
                  "enum": ["initializing", "queued", "in_progress", "available", "success_with_errors", "empty_list", "failed"],
                  "example": "queued"
                },
                "pdf_manager_template": {
                  "type": "object",
                  "required": ["id", "name", "href"],
                  "properties": {
                    "id": {
                      "type": "integer",
                      "example": 2
                    },
                    "name": {
                      "type": "string",
                      "example": "Accepted Offers for Review"
                    },
                    "href": {
                      "type": "string",
                      "pattern": "/api/v1/user_identities/\\d+/pdf_manager_templates/\\d+",
                      "example": "/api/v1/user_identities/1/pdf_manager_templates/2"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "description": "Initiate the creation of a batch from a template.  If you attempt to run the same export several times in close succession, you will receive the id of the already-running instance of that export. This is a safeguard to prevent many accidental simultaneous runs of the exact same export: one must finish before a new one can be initiated.",

      "href": "/api/v1/user_identities/:user_identity_id/pdf_manager_batches",
      "method": "POST",
      "rel": "create",
      "title": "Initiate Run",
      "http_header": { "x-api-key": "0123456789abcdef0123456789abcdef" },
      "schema": {
        "required": ["pdf_manager_template_id"],
        "properties": {
          "pdf_manager_template_id": {
            "type": "integer",
            "description": "Unique identifier of the template.",
            "example": 2
          },
          "callback": {
            "type": "string",
            "format": "uri",
            "description": "When the batch is completed, WebAdMIT will `POST` to this callback URL.  The `POST`ed JSON data uses the same schema as the GET request.",
            "pattern": "^https://",
            "example": "https://example.com/my_callback"
          }
        }
      }
    }
  ],

  "type": "object",
  "strictProperties": true,

  "properties": {
    "href": {
      "type": "string",
      "description": "Hypertext reference to this resource.",
      "pattern": "/api/v1/user_identities/\\d+/pdf_manager_batches/\\d+",
      "example": "/api/v1/user_identities/1/pdf_manager_batches/2"
    },
    "pdf_manager_batch": {
      "type": "object",
      "required": ["id", "updated_at", "state", "download_urls", "pdf_manager_template"],
      "properties": {
        "id": {
          "type": "integer",
          "description": "Unique identifier of this batch."
        },
        "updated_at": {
          "type": "string",
          "format": "date-time",
          "pattern": "\\d\\d\\d\\d-\\d\\d-\\d\\dT\\d\\d:\\d\\d:\\d\\dZ",
          "description": "Time that this batch was last updated.",
          "example": "2016-01-05T16:51:00Z"
        },
        "state": {
          "type": "string",
          "description": "Current state of this batch.  When `\"available\"`, the batch is ready for download.",
          "enum": ["initializing", "queued", "in_progress", "available", "success_with_errors", "empty_list", "failed"],
          "example": "queued"
        },
        "download_urls": {
          "comment": "FIXME: Include `items`.  See https://github.com/interagent/prmd/issues/275",
          "type": "array",
          "description": "When `state` is **not** `\"available\"` or `\"success_with_errors\"`, this is `[]`.  When `state` is `\"available\"` or `\"success_with_errors\"`, this is an array of *temporary* URIs for downloading that expire within 30 seconds.  The download URL can always be re-generated if it expires by calling this method again. When it is called again, a new URL will be issued.",
          "example": []
        },
        "pdf_manager_template": {
          "type": "object",
          "required": ["id", "name", "href"],
          "properties": {
            "id": {
              "type": "integer",
              "description": "Unique identifier of the template.",
              "example": 2
            },
            "name": {
              "type": "string",
              "description": "Human-readable name of this PDF Manager template.",
              "example": "Accepted Offers for Review"
            },
            "href": {
              "type": "string",
              "description": "Hypertext reference to the template.",
              "pattern": "/api/v1/user_identities/\\d+/pdf_manager_templates/\\d+",
              "example": "/api/v1/user_identities/1/pdf_manager_templates/2"
            }
          }
        }
      }
    }
  }
}
