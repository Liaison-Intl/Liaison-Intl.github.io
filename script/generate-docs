#!/usr/bin/env bash
set -o errexit

read_config() {
  webadmit_path=$(cat config/webadmit_path.txt)
}

# Use `prmd` to generate markdown from the JSON Schema files we use when testing.
#
# There's also a way of using `prmd` from a Rake task, but using this script
# avoids some current problems with conflicting Ruby versions.  (Changing to
# the Rake task would probably make sense in the future.)
generate_markdown_from_json_schema() {
  title="$1"
  json_schema_filename="schemata/$2"

  if [ -f "$3" ]; then
    extended_description_filename="$3"
  else
    extended_description_filename='/dev/null'
  fi

  footer_filename="$4"

  mkdir -p tmp
  bundle exec prmd combine --meta "$webadmit_path/schemata/meta.json" "$webadmit_path/$json_schema_filename" > tmp/schema.json
  bundle exec prmd doc tmp/schema.json > tmp/schema.md

  if [ -f "$footer_filename" ]; then
    echo >> tmp/schema.md
    cat "$footer_filename" >> tmp/schema.md
  fi

  cat <<EOF
---
layout: default
title: $title
---

<!-- WARNING: This is an automatically generated file.  Do not modify directly.  See script/generate-docs. -->

EOF

  ruby -r <<RUBY
require 'github/markup'
# Work around a [bug][] in prmd that erroneously continues a line when there is a header but no data.
#
#   [bug]: https://github.com/interagent/prmd/blob/34b7fbefa168a5c58fe012eb335d21b06e600323/lib/prmd/templates/schemata/link_curl_example.md.erb#L27
extended_description = File.read('$extended_description_filename')
puts GitHub::Markup.render("tmp/schema.md").sub('<h3>Attributes</h3>', "#{extended_description}\n<h3>Attributes</h3>").gsub(/ \\\s*\n<\/code><\/pre>/m, "\n</code></pre>")
RUBY

  echo # Without a trailing newline, Jekyll won't serve the file!

  rm tmp/schema.json tmp/schema.md
}

read_config
generate_markdown_from_json_schema 'User Identity' 'user_identity.json' 'user_identity_extended_description.md' '' > 'user_identity.md'
generate_markdown_from_json_schema 'Program' 'program.json' '' 'not_found.md' > 'program.md'
generate_markdown_from_json_schema 'Custom Field' 'custom_field.json' '' 'not_found.md' > 'custom_field.md'
